dist: trusty

language: php

php:
  - 5.5
  - 5.6
  - 7.0
env:
  - DB=mysql57
  - DB=mysql56

cache: 
  apt: true
  bundler: true
  directories:
    - $HOME/.composer/cache

: required

before_script:
  - "sudo su"
  - "/etc/init.d/mysql stop || true"
  - "bash -c \"if [ '$DB' = 'mysql57' ]; then echo deb http://repo.mysql.com/apt/ubuntu/ trusty mysql-5.7 | tee /etc/apt/sources.list.d/mysql.list; apt-key add .mysql/dev.mysql.com.gpg.key; apt-get install mysql-server-5.7; fi\""
  - "bash -c \"if [ '$DB' = 'mysql56' ]; then echo deb http://repo.mysql.com/apt/ubuntu/ trusty mysql-5.6 | tee /etc/apt/sources.list.d/mysql.list; apt-key add .mysql/dev.mysql.com.gpg.key; apt-get install mysql-server-5.6; fi\""

  # Config
  - "echo '[mysqld]'            |  tee /etc/mysql/conf.d/replication.cnf"
  - "echo 'log-bin=mysql-bin'   |  tee -a /etc/mysql/conf.d/replication.cnf"
  - "echo 'server-id=1'         |  tee -a /etc/mysql/conf.d/replication.cnf"
  - "echo 'binlog-format = row' |  tee -a /etc/mysql/conf.d/replication.cnf"

  # Enable GTID
  - "echo '[mysqld]'                       |  tee /etc/mysql/conf.d/gtid.cnf"
  - "echo 'gtid_mode=ON'                   |  tee -a /etc/mysql/conf.d/gtid.cnf"
  - "echo 'enforce_gtid_consistency'       |  tee -a /etc/mysql/conf.d/gtid.cnf"
  - "echo 'binlog_format=ROW'              |  tee -a /etc/mysql/conf.d/gtid.cnf"
  - "echo 'log_slave_updates'              |  tee -a /etc/mysql/conf.d/gtid.cnf"

  # Start mysql (avoid errors to have logs)
  - "/etc/init.d/mysql restart || true"
  - "tail -100 /var/log/syslog"

  - "mysql --version"
  - "mysql -u root -e 'SELECT VERSION();'"
  - "mysql -u root -e \"GRANT ALL PRIVILEGES ON *.* TO ''@'localhost';\""
  - "mysql_tzinfo_to_sql /usr/share/zoneinfo/ | mysql -u root mysql"
  
  - echo "USE mysql;\nUPDATE user SET password=PASSWORD('root') WHERE user='root';\nFLUSH PRIVILEGES;\n" | mysql -u root

install:
  travis_retry composer install --no-interaction --prefer-source;

script: vendor/bin/phpunit
